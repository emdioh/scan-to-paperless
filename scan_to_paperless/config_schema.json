{
  "$schema": "http://json-schema.org/draft-07/schema",
  "$id": "https://raw.githubusercontent.com/camptocamp/tilecloud-chain/master/tilecloud_chain/schema.json",
  "type": "object",
  "title": "Configuration",
  "additionalProperties": false,
  "definitions": {
    "auto_mask": {
      "type": "object",
      "title": "Auto mask",
      "properties": {
        "lower_hsv_color": {
          "type": "array",
          "description": "The lower color in HSV representation",
          "default": [0, 0, 250],
          "items": {
            "type": "integer"
          }
        },
        "upper_hsv_color": {
          "type": "array",
          "description": "The upper color in HSV representation",
          "default": [255, 10, 255],
          "items": {
            "type": "integer"
          }
        },
        "de_noise_morphology": {
          "type": "boolean",
          "description": "Apply a morphology operation to remove noise",
          "default": true
        },
        "inverse_mask": {
          "type": "boolean",
          "description": "Inverse the mask",
          "default": false
        },
        "de_noise_size": {
          "type": "integer",
          "description": "The size of the artifact that will be de noise",
          "default": 20
        },
        "de_noise_level": {
          "type": "integer",
          "description": "The threshold level used in de noise on the blurry image",
          "default": 220
        },
        "buffer_size": {
          "type": "integer",
          "description": "The size of the buffer add on the mask",
          "default": "50 an case of mask, 20 in case of cut"
        },
        "buffer_level": {
          "type": "integer",
          "description": "The threshold level used in buffer on the blurry image",
          "default": 20
        },
        "additional_filename": {
          "type": "string",
          "description": "An image file used to add on the mask"
        }
      }
    },
    "args": {
      "type": "object",
      "additionalProperties": false,
      "title": "Arguments",
      "properties": {
        "level": {
          "type": ["boolean", "integer"],
          "description": "true: => do level on 15% - 85% (under 15 % will be black above 85% will be white), false: => 0% - 100%, <number>: => (0 + <number>)% - (100 - number)%"
        },
        "auto_level": {
          "type": "boolean",
          "description": "If no level specified, do auto level",
          "default": false
        },
        "min_level": {
          "type": "number",
          "description": "Min level if no level end no auto-level",
          "default": 15
        },
        "max_level": {
          "type": "number",
          "description": "Max level if no level end no auto-level",
          "default": 15
        },
        "no_crop": {
          "type": "boolean",
          "default": false,
          "description": "Don't do any crop"
        },
        "margin_horizontal": {
          "type": "number",
          "default": 9,
          "description": "The horizontal margin used on auto-detect content [mm]"
        },
        "margin_vertical": {
          "type": "number",
          "default": 6,
          "description": "The vertical margin used on auto-detect content [mm]"
        },
        "dpi": {
          "type": "number",
          "default": 300,
          "description": "The DPI used to convert the mm to pixel"
        },
        "sharpen": {
          "type": "boolean",
          "default": false,
          "description": "Do the sharpen"
        },
        "dither": {
          "type": "boolean",
          "default": false,
          "description": "Do the dither"
        },
        "tesseract": {
          "type": "boolean",
          "default": false,
          "description": "Use tesseract to to an OCR on the document"
        },
        "tesseract_lang": {
          "type": "string",
          "default": "fra+eng",
          "description": "The used language for tesseract"
        },
        "append_credit_card": {
          "type": "boolean",
          "default": false,
          "description": "Do an assisted split"
        },
        "assisted_split": {
          "type": "boolean",
          "default": false,
          "description": "Do an assisted split"
        },
        "num_angles": {
          "type": "integer",
          "default": 1800,
          "description": "The number of angle used to detect the image skew"
        },
        "min_box_size_crop": {
          "type": "number",
          "default": 3,
          "description": "The minimum box size to find the content on witch one we will crop [mm]"
        },
        "min_box_black_crop": {
          "type": "number",
          "default": 2,
          "description": "The minimum black in a box on content find on witch one we will crop [%]"
        },
        "contour_kernel_size_crop": {
          "type": "number",
          "default": 1.5,
          "description": "The block size used in a box on content find on witch one we will crop [mm]"
        },
        "threshold_block_size_crop": {
          "type": "number",
          "default": 1.5,
          "description": "The block size used in a box on threshold for content find on witch one we will crop [mm]"
        },
        "threshold_value_c_crop": {
          "type": "number",
          "default": 70,
          "description": "A variable used on threshold, should be low on low contrast image, used in a box on content find on witch one we will crop"
        },
        "min_box_size_empty": {
          "type": "number",
          "default": 10,
          "description": "The minimum box size to find the content to determine if the page is empty [mm]"
        },
        "min_box_black_empty": {
          "type": "number",
          "default": 2,
          "description": "The minimum black in a box on content find if the page is empty [%]"
        },
        "contour_kernel_size_empty": {
          "type": "number",
          "default": 1.5,
          "description": "The block size used in a box on content find if the page is empty [mm]"
        },
        "threshold_block_size_empty": {
          "type": "number",
          "default": 1.5,
          "description": "The block size used in a box on threshold for content find if the page is empty [mm]"
        },
        "threshold_value_c_empty": {
          "type": "number",
          "default": 70,
          "description": "A variable used on threshold, should be low on low contrast image, used in a box on content find if the page is empty"
        },
        "min_box_size_limit": {
          "type": "number",
          "default": 3,
          "description": "The minimum box size to find the limits based on content [mm]"
        },
        "min_box_black_limit": {
          "type": "number",
          "default": 2,
          "description": "The minimum black in a box on content find the limits based on content [%]"
        },
        "contour_kernel_size_limit": {
          "type": "number",
          "default": 1.5,
          "description": "The block size used in a box on content find the limits based on content [mm]"
        },
        "threshold_block_size_limit": {
          "type": "number",
          "default": 1.5,
          "description": "The block size used in a box on threshold for content find the limits based on content [mm]"
        },
        "threshold_value_c_limit": {
          "type": "number",
          "default": 70,
          "description": "A variable used on threshold, should be low on low contrast image, used in a box on content find the limits based on content"
        },
        "colors": {
          "type": "integer",
          "default": 0,
          "description": "The number of colors in the png"
        },
        "run_optipng": {
          "type": "boolean",
          "default": true,
          "description": "Run the optipng optimizer"
        },
        "run_pngquant": {
          "type": "boolean",
          "default": false,
          "description": "Run the pngquant optimizer"
        },
        "pngquant_options": {
          "type": "array",
          "description": "The pngquant options",
          "default": ["--force", "--speed=1", "--strip", "--quality=0-32"],
          "items": { "type": "string" }
        },
        "run_exiftool": {
          "type": "boolean",
          "default": false,
          "description": "Run the exiftool optimizer"
        },
        "run_ps2pdf": {
          "type": "boolean",
          "default": false,
          "description": "Run the ps2pdf optimizer (=> JPEG)"
        },
        "jpeg": {
          "type": "boolean",
          "default": false,
          "description": "Convert images to JPEG"
        },
        "jpeg_quality": {
          "type": "integer",
          "default": 90,
          "description": "The JPEG quality"
        },
        "background_color": {
          "type": "array",
          "default": [255, 255, 255],
          "description": "The background color",
          "items": { "type": "integer" }
        },
        "auto_mask": {
          "description": "The auto mask configuration, the mask is used to mask the image on crop and deskew calculation",
          "$ref": "#/definitions/auto_mask"
        },
        "auto_cut": {
          "description": "The auto mask configuration, the mask is used to definitively mask the source image",
          "$ref": "#/definitions/auto_mask"
        }
      }
    }
  },
  "properties": {
    "extends": {
      "type": "string",
      "description": "The configuration to extends"
    },
    "merge_strategies": {
      "type": "object",
      "title": "Merge strategies",
      "description": "The merge strategy to use, see https://deepmerge.readthedocs.io/en/latest/strategies.html#builtin-strategies",
      "properties": {
        "list": {
          "type": "array",
          "description": "The merge strategy to use on list",
          "default": ["override"],
          "items": { "type": "string" }
        },
        "dict": {
          "type": "array",
          "description": "The merge strategy to use on dict",
          "default": ["merge"],
          "items": { "type": "string" }
        },
        "fallback": {
          "type": "array",
          "description": "The fallback merge strategy",
          "default": ["override"],
          "items": { "type": "string" }
        },
        "type_conflict": {
          "type": "array",
          "description": "The type_conflict merge strategy",
          "default": ["override"],
          "items": { "type": "string" }
        }
      }
    },
    "scan_folder": {
      "type": "string",
      "description": "This should be shared with the process container in 'source'."
    },
    "scanimage": {
      "type": "string",
      "default": "scanimage",
      "description": "The scanimage command"
    },
    "scanimage_arguments": {
      "type": "array",
      "description": "The scanimage arguments",
      "default": ["--format=png", "--mode=color", "--resolution=300"],
      "items": { "type": "string" }
    },
    "extension": {
      "type": "string",
      "description": "The extension of generate image (png or tiff)",
      "default": "png"
    },
    "default_args": {
      "$ref": "#/definitions/args"
    },
    "viewer": {
      "type": "string",
      "description": "The command used to start the viewer",
      "default": "eog"
    },
    "modes": {
      "type": "object",
      "description": "Customize the modes",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "scanimage_arguments": {
            "description": "Additional scanimage arguments",
            "type": "array",
            "items": { "type": "string" }
          },
          "auto_bash": {
            "type": "boolean",
            "description": "Run the ADF in tow step odd and even, needed for scanner that don't support double face"
          },
          "rotate_even": {
            "type": "boolean",
            "description": "Rotate the even pages, to use in conjunction with auto_bash"
          }
        }
      }
    }
  }
}
